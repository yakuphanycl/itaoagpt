name: CI

on:
  push:
  pull_request:

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install (editable)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Contract tests (fast)
        shell: pwsh
        run: |
          .\tools\contract_tests.ps1

      - name: TEXT smoke test
        shell: pwsh
        run: |
          .\tools\smoke_text.ps1

      - name: Create test log (wheel gate fixture)
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          @'
          2026-02-24 11:00:00 INFO boot
          2026-02-24 11:00:01 WARN cache miss
          2026-02-24 11:00:02 ERROR db timeout after 2000ms
          2026-02-24 11:00:03 INFO retry
          2026-02-24 11:00:04 CRITICAL out of memory
          '@ | Set-Content -LiteralPath .\tmp_test.log -Encoding utf8

      - name: Release check (wheel gate)
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          .\tools\release_check.ps1
